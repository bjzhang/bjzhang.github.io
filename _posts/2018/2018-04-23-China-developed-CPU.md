---
layout: post
title: 技术贴：操作系统业者梳理中国CPU
categories: [Tech]
tags: [Tech, CPU]
---

（为了照顾微信公众号无法跳转非微信链接的限制，所有链接都统一放到最后）

最近中兴事件大家议论很多。笔者一直觉得专业的人做专业的事情，经济，贸易这些我也不太懂。恰好是芯片专业，后来一直做操作系统相关的工作，这些年对于国内cpu，soc也比较关注。正好借这个机会梳理下。

上大学的时候，学校的一个机房曾经也部署过方舟CPU的瘦客户端。过了两年，换成普通PC了，当时的瓶颈似乎是带宽不够。我觉得领先两步是烈士，当年我们各个方面差距非常大，这些年我们虽然高端制造还有极大差距，但是很多东西还是追了上来。但是如果没有方舟们之前的工作，没有当时方舟的成功流片，就没有后来我们对体系结构这么深的理解，也没有君正，申威，国防科大，展讯等很多公司现在能够继续在自研CPU上继续往下走。操作系统方面，我们现在虽然没有一个能够有完整生态操作系统，但是在嵌入式领域，我们有rt-thread。在操作系统的探索方面，我们有全球操作系统大牛陈海波。

笔者收集了一些国内公司CPU的情况。首先需要说明的是，国内CPU公司的设计不一定都在国内，技术发展水平，美国出口限制（并不是专门针对大陆）等原因导致很多国内公司CPU的一部分设计在国外。如前文所有，像剥洋葱一样，一步一步的解决技术问题就好。

本文没有借东风，火烧赤壁的精彩。聚焦在中国CPU，分析且仅仅往下分析一层，可能比各种吐槽有意义。

本文思路
--------
CPU其实有不同的场景，也有不同的需求。做东西还是为了满足诉求，不是为了做而做。比如国家安全，比如针对自己场景做特定的优化。超算领域，我们有申威CPU，手机芯片有展讯的SC9850KH，服务器方面我们有龙芯，低功耗CPU有君正。基本思路：
1.  本文说什么，不说什么；
2.  介绍国内公司研发的CPU现状；
3.  上述CPU背后的关系。

### 本文会涉及
1.  CPU与SOC的区别：所有只做SOC的公司或者CPU设计弱鸡公司就不讨论了。
2.  CPU与GPU，DSP，MPU，NPU的区别。
3.  我国参与的CPU涉及的架构和专利。

### 本文不会说
1.  CPU和操作系统及其生态：网上不少人说到CPU和操作系统就说生态，就好像我去爬山你非要和我讨论环境保护。生态重要，但是和CPU和操作系统的研发和应用并不是同一个话题。
2.  抽象的计算机体系架构：简单说只说CPU涉及到的工程实现，不说学术。计算机体系结构可以参考：http://iscaconf.org/isca2018/program.html
3.  不发散计算要怎么做：CPU是用于计算的，除了XXU之外，还有DNA计算，量子计算。
4.  CPU是否重要：讨论问题没有边界就没法讨论，本文以CPU重要为前提。
5.  芯片设计软件（EDA工具）：CPU工程的设计属于芯片设计，芯片设计需要与芯片生产工艺相关的芯片设计软件。
6.  Foundry，即芯片制造商，国内最大的制造商是中芯国际，大中华区最大的是台积电，全球最大的是英特尔。投资周期长，投资以10亿美元为单位。
7.  芯片生产设备（即芯片制造设备）属于高端制造的一部分。全球芯片生产设备集中在美国日本荷兰。这个笔者也不太了解，后面又涉及到禁运。
8.  芯片设计和制造流程：二者极为都极为复杂，而且与CPU设计生产没有直接关系，超过了笔者只想多分析一层的计划，本文完全不打算涉及。
9.  各种爆料和猜测。听起来有趣或激动人心。实际试图去了解它们背后的逻辑更为重要。

中国研究机构或公司研发的CPU
---------------------------
听着很拗口，实际不好简化。全球化时代，你中有我我中有你。军工笔者不了解，其余都或多或少是全球研发。从独立自主到自主可控其实也反映了这种趋势。所谓本文不会使用中国芯，国产CPU这种比较误导人的叫法。

每家CPU的介绍思路是
1.  发展历史，剥洋葱消化吸收的过程。
2.  目前最新处理器的架构和生态。

### CPU和芯片是什么关系？
经常有个说法是中国无芯，很有意思的是，结束中国无芯的历史也被宣布好几次了。CPU是计算机系统的核心，计算和逻辑处理在这里完成。CPU做出来就是芯片，比如去中关村买intel i7（TODO图片）。同时还有个名词是SOC，中文是片上系统。简单说，SOC就是把若干模块，例如把CPU，显卡，内存控制器等原本多个芯片组成的系统放到了一个芯片。在我们的PC和服务器领域，通常CPU是个单独的芯片。但是在手机中一般是SOC以提高系统可靠性，降低功耗。笔记本中也经常有CPU和GPU在一个芯片的情况。本文不说SOC设计公司，只说CPU设计公司。例如龙芯服务器芯片，是单独的CPU芯片。展讯的手机芯片是包括了展讯自研CPU的SOC芯片。单纯做SOC的公司不在讨论之列。

如果仔细看全球自研CPU的发展，尤其是自研ARM CPU的发展，能看到明显的先购买ARM CPU和其它IP，自己设计SOC，逐步到SOC级别的优化，模块的优化。CPU作为SOC中最复杂的模块之一，要想有断裂点，只能自己做。除了军工或国家安全的需要。自己做CPU，一个是微架构的设计可以更符合场景的需要，例如更好的性能功耗比等等。还有就是可以加一些私货，在体系结构允许范围内做优化或加自己的扩展。

### 申威
申威处理器又称"SW处理器"，具体负责研发的单位是江南计算机所属于军方研究机构(总参56所)，2006年推出第一代处理器，目前共有4代处理器。其中前三代源于DEC Alpha架构。第四代26010架构不详，官方文档明确说不是alpha架构(Shenwei-64  Instruction Set (this is NOT related to the DEC Alpha instruction set))，架构设计类似与Power cell架构：每个通用处理核心与64个SIMD向量处理器搭配，每个计算节点共4个通用处理器+256个计算节点（256 CPEs (computing  processing  elements) + 4  MPEs (management processing  elements)）

### 龙芯
龙芯(Loongson)是中科院计算所研发的，属于mips兼容架构。2002年推出第一代处理器（32位）。2003年10月17日，龙芯2号首片MZD110流片成功，纪念毛泽东主席诞辰110周年。最新一代是龙芯3。成功流片后，计算所内部服务器替换使用龙芯服务器。
作为一款通用处理器，龙芯至迟从2004年开始做x86软件运行加速工作，基本有两个思路，一个是硬件指令集扩展；一个是软件DBT优化(解释DBT)。
mips是个老牌架构，龙芯的Loongson ISA在mips上也有扩展，其实也是个消化吸收并针对需求优化的国产。龙芯已经成为Debian的mipsel架构的编译机器，说明龙芯完全兼容mips，同时龙芯对于生态的投入。

TODO等待回复：本人原来在华为做Linux内核，现在在海航云做分布式存储。对国内cpu发展一直比较关注，想请教下面问题是否可以分享下：
1.  龙芯下一代产品的指标。
2.  龙芯对于x86软件的支持方式？指令集支持？DBT模拟？目前性能损失有多少?
3.  看到debian编译mips使用了龙芯的芯片，请问龙芯对于开源社区支持的具体情况如何？

MIPS架构其实还有君正。君正的核心人员来自方舟，之前做过MP4芯片，平板芯片，目前主攻智能穿戴。由于MIPS架构的优势和自身技术积累，君正的SOC功耗控制都很好。

### 展讯
展讯除了arm架构还有和intel合作的x86 SOC。这里只说arm。arm架构的特点是在移动端android生态完善，在HPC，云计算方面有多家公司持续投入。例如老牌网络公司cavium，占领欧洲的发行版公司suse，惠普功能在英国（TODO链接）上线HPC项目。云计算方面，阿里上线测试arm64服务器。这些都是arm生态的机会。
展讯当年因为中国移动运营的TD-SCDMA步调慢，差点死掉。后来凭借TD的订单，一直持续投入做基带芯片，并且逐步开始做手机AP芯片。也就是我们说的手机CPU。后来才有了现在说的[自研CPU SC9850KH](https://mp.weixin.qq.com/s/0jH4uoEv0UsMuKOFZiozIQ)。从文章看，主打性能功耗比，是cortex-A53的竟品。据知情人透露，SC9850KH是大小核架构，其中大核是两个支持了SMT（硬件多线程）的自研CPU，小核是Cortex-A53，Linux看到的是6个核（一种配置是2 x 2 SMT@1.5G + 2 x CA53@1.5G，具体频率会因产品有所不同)。arm架构硬件多线程是趋势，不过手机里面用的好很少（或没有？）。这里也能看出展讯CPU团队的技术积累。

背后的故事
-----------
### 架构之争
网上很多人讲x86和arm架构的历史，不就重复了。也有人说跳出cpu和操作系统，直接[用javascript跳跃式发展](https://mp.weixin.qq.com/s/gpfMOW7gzVa2HhYOlDy2nQ)。笔者这里不讨论是否可以，业务软件我不懂，这部分业务和应用软件的专家和吃瓜群众讨论就好了。我们还是聚焦到CPU。

到底选择什么样的架构？要不要做一个全新架构？这个问题我也不打算回答，我还是聊一聊MIPS和ARM的小关系。清华紫光集团联席总裁，前展讯CEO的李力游最近去了全球三大GPU厂家之一Imagination。过去几年苹果手机一直使用Imagination的GPU（俗称显卡）。2012年MIPS公司被Imagiation和AST(Allied Security Trust)收购。简单说前者买了MIPS公司的实体和MIPS专利中与MIPS CPU直接相关的专利。后者AST是20多家公司联合成立的。在MIPS被收购中，AST花了$350M(约21亿人民币)买了498项专利，这些专利是通用的cpu专利，ARM公司出资大约是一半。为什么ARM公司要出这么多钱？ ARM CEO Warren East当时说：
>   "Litigation is expensive and time-consuming and, in this case, a collective approach with other major industry players was the best way to remove that risk."

翻译过来就是，ARM不买这些专利，就是等着别人诉讼，花钱只会更多。不过话说回来，做x86的intel, AMD和做power的IBM也有很多通用的CPU专利，暂时风平浪静，没有诉讼。技术角度讲，64位arm处理器与32位arm处理器是不同的设计，前者和MIPS有大量类似之处，有人说是"70-80%的相似度"，笔者没有考证过。ARM公司尚且如此，国内公司如果完全做一个新的64位架构，专利风险有多大，不言而喻。所以笔者认为，对于商业产品来说，龙芯，飞腾，展讯等公司合法购买已有体系结构的授权，是唯一的选择。

抛开技术上MIPS和ARM的纠葛，只是看人的流向，当年方舟同时做自研架构和MIPS架构，给后来有些做ARM CPU的公司培养了人才。体系结构其实有万千，但是万变不离其宗，其实我们国家做不管是mips还是arm都属于对总体来说都属于risc。在扩大些说，不管是RISC还是CISC，其实技术特性的比较，比如说性能功耗比，它主要取决于微架构设计，而微架构其实在体系结构之间，哪怕是cisc和rics间都是高度共通的，所以这种CPU微架构的设计，其实不管做什么体系结构，都会有积累。就像intel当年想做嵌入式，选择了arm，和ADI联合研发MSA架构，并设计了xscale系列CPU及其SOC。后来xcale卖给了marvell。直到现在marvell仍然是沿着xscale架构的路线持续演进。

### 杂七杂八
国内明确做cpu的其实还有两家，一个是国防科大的飞腾，一个是兆芯。
国防科大飞腾：原来是sparcv8, 现在是armv8，前年飞腾arm64芯片出来时争议很大，从芯片spec看只能用在服务器领域。兆芯：x86，2018年授权到期，据说只是不能用2018年之后的指令集，原来指令集授权仍然有效。这两家公司笔者暂时了解不到具体情况，欢迎大家合法爆料多给些输入。

### 华为？
另外一个值得说一说的公司是华为，华为的海思，从20多年以前开始做芯片，目前的芯片已经广泛用到华为各个产品线中，华为的手机也从最开始的k3(SOC)的祖传暖手宝，到现在的麒麟970，性能逐渐改善已经进入手机芯片第一梯队。麒麟芯片目前用在华为所有的中高端手机中，年出货量超过千万。按照展讯的逻辑？华为有没有做CPU？2016年的时候，曾经有文章说华为的泰山自研CPU的SOC Hi1612流片，但是随后被华为辟谣，我们不去讨论华为目前有没有自研CPU。但是如前所述，从做SOC到做CPU是一个逐步深入的过程，因此不管华为有没有做自己的CPU，华为做SOC所培养的技术人才，对于我们做CPU来说都是非常重要的积累。
顺便八卦一下，k3是喀喇昆仑山的第三高峰-布洛德峰，可以看到华为芯片一直以山命名。这个很很多SOC公司单纯数字编号相比，更说明了华为心中的志向。再比如华为2012年建立了2012实验室，喜欢以科学家名字命名，例如图灵，欧拉，高斯，这里就不展开了，可以参考[真正的出路：重读任正非2012实验室讲话](https://mp.weixin.qq.com/s/IMUfA-SEcqra_8RIa7AY0g)

“都两个肩膀扛一个脑袋，啥高科技都架不住你天天琢磨。”

参考链接
--------
1.  CPU
    1.  申威
        1.  <http://www.netlib.org/utk/people/JackDongarra/PAPERS/sunway-report-2016.pdf>
        2.  <https://zh.wikipedia.org/wiki/%E7%94%B3%E5%A8%81%E5%A4%84%E7%90%86%E5%99%A8>
        3.  <http://www.eefocus.com/mcu-dsp/370966/r0>
    2.  龙芯
        1.  <https://zh.wikipedia.org/wiki/%E9%BE%99%E8%8A%AF>
        2.  DBT: <https://lt.cjdby.net/thread-526768-1-1.html> 
    3.  展讯
        1.  <https://mp.weixin.qq.com/s/0jH4uoEv0UsMuKOFZiozIQ>
        2.  首款国产 自主手机CPU，紫光展锐SC9850KH正式亮相: <http://t.cj.sina.com.cn/articles/view/5772303575/1580e5cd7001004pvx?cre=tianyi&mod=pcpager_fintoutiao&loc=13&r=9&doct=0&rfunc=100&tj=none&tr=9>
    4.  MIPS被收购
        1.  MIPS公司被Imagination和AST两家公司拆分收购之后，对国内基于MIPS架构的CPU设计公司有哪些影响？比如龙芯: <https://www.zhihu.com/answer/16061799>
        1.  ARM Holdings licenses big chunk of MIPS patents: <https://www.theregister.co.uk/2012/11/06/mips_sells_itself_to_imagination_arm/>
2.  芯片制造厂(foundry)  <https://en.wikipedia.org/wiki/Semiconductor_fabrication_plant>
3.  知乎：“现在有哪些国产 CPU 和操作系统？现状如何？”：<https://www.zhihu.com/question/58816532>
4.  李力游：<http://www.esmchina.com/news/article/201804031625>
5.  华为海思芯片命名，"华为海思K3芯片命名曝光：为喀喇昆仑山峰": <http://info.tele.hc360.com/2009/07/210936144523.shtml>
6.  禁运
    1.  瓦瑟纳尔协议 <https://zh.wikipedia.org/wiki/%E7%93%A6%E8%81%96%E7%B4%8D%E5%8D%94%E5%AE%9A>
    2.  哪些设备技术对中国禁运? <https://www.zhihu.com/question/53217224/answer/151017560>

