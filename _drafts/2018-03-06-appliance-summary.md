

å„ç§é•œåƒæ‰“åŒ…æ–¹å¼æ€»ç»“

å®é™…å·¥ä½œä¸­å¯èƒ½æ¶‰åŠåˆ°åœ¨ç‰¹å®šç¯å¢ƒéƒ¨ç½²ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºï¼Œå¯èƒ½å¸Œæœ›ç³»ç»Ÿä¸€é”®éƒ¨ç½²åç›´æ¥å¯ç”¨ã€‚ä¸€èˆ¬æœ‰ä¸¤ç±»æ€è·¯ï¼Œä¸€ä¸ªæ˜¯åšä¸€ä¸ªghosté•œåƒï¼Œç›´æ¥å†™å…¥ç›®æ ‡ç³»ç»Ÿï¼Œç³»ç»Ÿå¯åŠ¨åç›´æ¥å¯ä»¥ä½¿ç”¨ã€‚ç¬¬äºŒä¸ªæ˜¯å¯åŠ¨æˆ–å®‰è£…ä¸€ä¸ªé»˜è®¤ç³»ç»Ÿï¼Œä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·é…ç½®ç¯å¢ƒã€‚æ›´å¤æ‚çš„æƒ…å†µæ˜¯ä¸¤è€…çš„ç»“åˆã€‚

ç¬¬äºŒç§æ–¹æ³•åŒ…æ‹¬ansible, fabricç­‰æ–¹æ³•ã€‚æœ¬æ–‡åªè®¨è®ºç¬¬ä¸€ç§æ–¹æ³•ã€‚ç¬¬äºŒç±»æ–¹æ³•åç»­ã€‚

Linuxå‘è¡Œç‰ˆä¸€é”®å®‰è£…æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥åˆ†ä¸ºé¢„å…ˆå®‰è£…å’Œé¢„å…ˆå†™å¥½é…ç½®æ–‡ä»¶ä¸€é”®å®‰è£…ä¸¤ç§æ–¹å¼ã€‚

é€šè¿‡é…ç½®æ–‡ä»¶ä¸€é”®å®‰è£…é€šå¸¸å’Œå‘è¡Œç‰ˆè”ç³»æ¯”è¾ƒç´§å¯†ï¼Œä¾‹å¦‚suseæœ‰autoyastï¼Œredhatæœ‰kickstartã€‚todoé“¾æ¥ã€‚è¿™ç±»æ–¹æ³•ä»¥ä¸€ä¸ªç®¡ç†å‘˜æ‰‹å·¥å®‰è£…çš„è„šæœ¬ä¸ºåŸºç¡€ï¼Œè¿›ä¸€æ­¥ä¿®æ”¹åšæˆã€‚ç”±äºæ¯æ¬¡é‡æ–°å®‰è£…æ—¶é—´è¾ƒé•¿ã€‚é€‚åˆäºéœ€è¦ç»™å°‘é‡å‡ å°æœºå™¨éƒ¨ç½²ã€‚

å‰ä¸€ç§æ–¹æ³•å’Œåœ¨äº‘åŒ–åœºæ™¯ä¸­é€‰æ‹©è‡ªå®šä¹‰é•œåƒç±»ä¼¼ã€‚å®é™…åº”ç”¨ä¸­ï¼Œä¸ç®¡ç‰©ç†æœºè¿˜æ˜¯è™šæ‹Ÿæœºè¿˜æ˜¯äº‘åŒ–åœºæ™¯çš„é•œåƒå®šåˆ¶ï¼Œéƒ½é€‚åˆã€‚

é¢„å…ˆå®‰è£…éœ€è¦åˆ¶ä½œä¸€ä¸ªç£ç›˜é•œåƒï¼Œä¸€é”®éƒ¨ç½²æ—¶é€‰æ‹©æŒ‡å®šçš„ç£ç›˜ç›´æ¥å†™å…¥å¹¶è®¾ç½®bootloaderä¹‹åå³å¯ä½¿ç”¨ã€‚æœ‰suseçš„kiwiï¼Œredhatçš„virt-builder, virt-p2vé‡Œé¢ç”¨çš„é‚£ä¸ª, terraform.

å…¶ä¸­åªæœ‰kiwiæ”¯æŒä»ç‰©ç†æœºï¼Œè™šæ‹Ÿæœºåˆ°äº‘åŒ–åœºæ™¯çš„é•œåƒæ„å»ºå’Œéƒ¨ç½²ã€‚terraformæ”¯æŒè·¨æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿæœºï¼Œä½†æ˜¯ä¸æ”¯æŒç‰©ç†æœºï¼Œå°¤å…¶é€‚åˆä¸ªäººç”¨æˆ·ã€‚

ç½‘ä¸Šä¸­æ–‡ææ–™åŸºæœ¬è¯´çš„éƒ½æ˜¯kiwiä¸æ˜¯æœ€æ–°çš„kiwi-ngï¼Œè€Œä¸”ç¼ºä¹å®šåˆ¶åŒ–ç»†èŠ‚ã€‚


kiwiè¶…å¿«ä¸Šæ‰‹
--------------
wget Vagrantfile
mkdir vagrant_kiwi
cd vagrant_kiwi
vagrant up

public/sources/vagrant_kiwi/build_kiwi.sh
å‡†å¤‡kiwiç¯å¢ƒå¹¶æ„å»ºé•œåƒã€‚
è„šæœ¬ä¸ºäº†ç¼–è¯‘å¤§å®¶ç²˜è´´æ¯ä¸€è¡Œï¼Œæ²¡æœ‰ä½¿ç”¨ä»»ä½•å˜é‡ã€‚

kiwi descriptioné‡Œé¢åŒ…å«ä¸åŒå‘è¡Œç‰ˆï¼Œä¾‹å¦‚suseï¼Œopensuseéƒ½åœ¨suseç›®å½•ï¼Œredhatï¼Œcentosï¼Œdebianç­‰ç­‰ï¼Œä¸‹é¢å‘½ä»¤åˆ†åˆ«æ„å»ºäº†opensuse42.3å’Œcentos7çš„é•œåƒ
```
APPLIANCE=suse/x86_64/suse-leap-42.3-JeOS/
sudo kiwi-ng --debug --color-output --type oem system build --target-dir $HOME/works/software/kiwi --description $APPLIANCE
```
```
APPLIANCE=centos/x86_64/centos-07.0-JeOS/
sudo kiwi-ng --debug --color-output --type oem system build --target-dir $HOME/works/software/kiwi --description $APPLIANCE
```

è¿™é‡Œæä¾›ä¸€ä¸ªæ ‡å‡†æºä¸€ä¸ªå›½å†…æºçš„é…ç½®æ–‡ä»¶ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„ç½‘ç»œæƒ…å†µé€‰æ‹©ã€‚

æ„å»ºæˆåŠŸä¹‹åé•œåƒç›®å½•ï¼š
```
[ INFO    ]: 04:07:37 | Result files:
[ INFO    ]: 04:07:37 | --> disk_image: /home/vagrant/works/software/kiwi/LimeJeOS-Leap-42.3.x86_64-1.42.3.raw
[ INFO    ]: 04:07:37 | --> image_packages: /home/vagrant/works/software/kiwi/LimeJeOS-Leap-42.3.x86_64-1.42.3.packages
[ INFO    ]: 04:07:37 | --> image_verified: /home/vagrant/works/software/kiwi/LimeJeOS-Leap-42.3.x86_64-1.42.3.verified
[ INFO    ]: 04:07:37 | --> installation_image: /home/vagrant/works/software/kiwi/LimeJeOS-Leap-42.3.x86_64-1.42.3.install.iso
[ INFO    ]: 04:07:37 | Cleaning up BootImageDracut instance
```
ä½¿ç”¨æ–¹æ³•ï¼š
1.  è™šæ‹Ÿæœº
2.  ç‰©ç†æœº
    TODOæˆªå±ã€‚

æ„å»ºä¹‹åè¦åˆ é™¤æ„å»ºç›®å½•ï¼Œå¦åˆ™ä¼šæç¤ºï¼š
```
[ INFO    ]: 03:53:22 | Setup root directory: /home/vagrant/works/software/kiwi/build/image-root
[ ERROR   ]: 03:53:22 | KiwiRootDirExists: Root directory /home/vagrant/works/software/kiwi/build/image-root already exists
[ INFO    ]: 03:53:22 | Cleaning up SystemPrepare instance
vagrant@os74:~/works/source/kiwi-descriptions> sudo rm -rf ~/works/software/kiwi/build/image-root
```


kiwiå®šåˆ¶åŒ–
----------
kiwiçš„æ–¹ä¾¿ä¹‹å¤„æ˜¯å¯ä»¥å¾ˆå®¹æ˜“çš„å®šä¹‰è‡ªå·±çš„é•œåƒã€‚è¿™é‡Œä¸¾å‡ ä¸ªæ —å­ğŸŒ°ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒkiwi_customizationåˆ†æ”¯çš„ä¾‹å­
1.  ä¿®æ”¹æˆ–å¢åŠ è½¯ä»¶æº
    æ¯”å¦‚å…¬å¸æˆ–å­¦æ ¡å†…ç½‘æœ‰ä¸ªé•œåƒï¼Œæˆ‘å¯ä»¥è¿™æ ·ä¿®æ”¹config.xml
	```
	commit cafb99c233d958f01845eb8aa54f538783d709dd (HEAD -> kiwi_customization)
	Author: Bamvor Zhang <bamv2005@gmail.com>
	Date:   Sat Mar 10 10:31:27 2018 +0800

		examples: use tsinghua mirror instead of the default one

		Signed-off-by: Bamvor Zhang <bamv2005@gmail.com>

	diff --git a/suse/x86_64/suse-leap-42.3-JeOS/config.xml b/suse/x86_64/suse-leap-42.3-JeOS/config.xml
	index 0886cbc..7747b69 100644
	--- a/suse/x86_64/suse-leap-42.3-JeOS/config.xml
	+++ b/suse/x86_64/suse-leap-42.3-JeOS/config.xml
	@@ -42,7 +42,7 @@
			 <source path="obs://Virtualization:Appliances:Builder/openSUSE_Leap_42.3"/>
		 </repository>
		 <repository type="rpm-md" alias="Leap_42_3" imageinclude="true">
	-        <source path="obs://openSUSE:Leap:42.3/standard"/>
	+        <source path="https://mirrors.tuna.tsinghua.edu.cn/opensuse/distribution/leap/42.3/repo/oss/"/>
		 </repository>
		 <packages type="image">
			 <package name="checkmedia"/>
	```
	æ¯”å¦‚æˆ‘æƒ³å¢åŠ ä¸€ä¸ªæºï¼Œå¹¶ä¸”å¸Œæœ›è¿™ä¸ªæºåœ¨é•œåƒä¸­ä¹Ÿæœ‰æ•ˆï¼Œä¾‹å¦‚æˆ‘å¸Œæœ›æµ‹è¯•æœ€æ–°ç¤¾åŒºå†…æ ¸ï¼ˆæ²¡æœ‰suseè¡¥ä¸ï¼‰çš„æŸä¸ªç‰¹æ€§ï¼Œæˆ‘å¯ä»¥è¿™æ ·ä¿®æ”¹ï¼›
	```
	commit c4c416c9884081ae5cc50bd8e77df50a60624e50 (HEAD -> kiwi_customization)
	Author: Bamvor Zhang <bamv2005@gmail.com>
	Date:   Sat Mar 10 10:57:57 2018 +0800

		examples: use lastest uptream kernel for kernel tester and low level user space development

		Signed-off-by: Bamvor Zhang <bamv2005@gmail.com>

	diff --git a/suse/x86_64/suse-tumbleweed-JeOS/config.xml b/suse/x86_64/suse-tumbleweed-JeOS/config.xml
	index 71c715a..55d7d77 100644
	--- a/suse/x86_64/suse-tumbleweed-JeOS/config.xml
	+++ b/suse/x86_64/suse-tumbleweed-JeOS/config.xml
	@@ -29,6 +29,9 @@
		 <repository type="yast2" alias="Tumbleweed" imageinclude="true">
			 <source path="http://download.opensuse.org/tumbleweed/repo/oss"/>
		 </repository>
	+    <repository type="yast2" alias="Kernel HEAD"  priority="2" imageinclude="true">
	+        <source path="https://download.opensuse.org/repositories/Kernel:/HEAD/standard/"/>
	+    </repository>
		 <packages type="image">
			 <package name="patterns-openSUSE-base"/>
			 <package name="plymouth-branding-openSUSE"/>
	@@ -52,7 +55,7 @@
			 <package name="bash-completion"/>
			 <package name="dhcp-client"/>
			 <package name="which"/>
	-        <package name="kernel-default"/>
	+        <package name="kernel-vanilla"/>
			 <package name="timezone"/>
		 </packages>
		 <packages type="iso">
	```

2.	å¢åŠ è½¯ä»¶åŒ…
    æ¯”å¦‚æˆ‘å¸Œæœ›åœ¨centos7é•œåƒé‡Œé¢åŠ å…¥dockerå‘½ä»¤ï¼Œå¯ä»¥è¿™æ ·ä¿®æ”¹ï¼š
    ```
    commit 219124102d731debc0544b4aa1772568104b9e5a (HEAD -> kiwi_customization)
    Author: Bamvor Zhang <bamv2005@gmail.com>
    Date:   Sat Mar 10 11:10:28 2018 +0800

        examples: add docker command in centos7 image

        Signed-off-by: Bamvor Zhang <bamv2005@gmail.com>

    diff --git a/centos/x86_64/centos-07.0-JeOS/config.xml b/centos/x86_64/centos-07.0-JeOS/config.xml
    index d1491f8..8df4692 100644
    --- a/centos/x86_64/centos-07.0-JeOS/config.xml
    +++ b/centos/x86_64/centos-07.0-JeOS/config.xml
    @@ -51,6 +51,7 @@
             <package name="grub2"/>
             <package name="kernel"/>
             <package name="plymouth-theme-charge"/>
    +        <package name="docker"/>
         </packages>
         <packages type="iso">
             <package name="dracut-kiwi-live"/>
    ```

3.  å¢åŠ äºŒè¿›åˆ¶åŒ…
    1.  æ¯”å¦‚æˆ‘ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¸‹è½½çš„è½¯ä»¶ï¼Œæ²¡æœ‰å®‰è£…æºï¼Œåªæœ‰äºŒè¿›åˆ¶ï¼Œä¾‹å¦‚æˆ‘è¦ä½¿ç”¨åˆ†å¸ƒå¼æ•°æ®åº“TiDBï¼Œå¯ä»¥è¿™æ ·ä¿®æ”¹
    <archive name="binaries.tar.gz"/>

4.  ä¿®æ”¹ç³»ç»Ÿé…ç½®ã€‚
    root/etc/sysctl.d/99-tidb.conf

5.  å…¶å®ƒå®šåˆ¶
    config.sh

kiwiå…å®‰è£…é€‰æ‹©
--------------
kiwiå®‰è£…æ—¶éœ€è¦é€‰æ‹©ç£ç›˜ï¼ˆå¦‚æœç£ç›˜æœ‰å¤šå—ï¼‰ï¼Œè¿˜éœ€è¦ç¡®è®¤æ ¼å¼åŒ–ï¼Œå¦‚æœæˆ‘ç¡®å®šè¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥å»æ‰è¿™äº›é€‰é¡¹ã€‚

kiwiè°ƒè¯•
--------
æ—¥å¿—ä½äº: "$HOME/works/software/kiwi/build/image-root.log"
æ„å»ºé•œåƒç”Ÿæˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ: "$HOME/works/software/kiwi/build/image-root"

kiwiéƒ¨ç½²
--------
### ç‰©ç†æœº
ç‰©ç†æœºæ”¯æŒpxeï¼Œå…‰ç›˜å¯åŠ¨ï¼Œç¡¬ç›˜ç›´æ¥ddã€‚
### è™šæ‹Ÿæœº
ä»¥libvirtä¸ºä¾‹ã€‚
### äº‘
google cloud æ„Ÿè§‰æ²¡ç©ºåšã€‚
è¦ä¸è¦å’Œsuse studio amsé•œåƒç»“åˆä¸€èµ·è¯´ï¼Ÿ

kiwiå®˜æ–¹æ–‡æ¡£
------------
[kiwi quick start](https://suse.github.io/kiwi/quickstart.html)
[google group](https://groups.google.com/forum/#!forum/kiwi-images)
YaST æ˜ åƒåˆ›å»ºç¨‹åºæ˜¯ KIWI æ˜ åƒå·¥å…·çš„å›¾å½¢ç•Œé¢
<https://www.suse.com/zh-cn/documentation/sles-12/book_sle_deployment/data/cha_imgcreator.html>

vagrantè·¨å¹³å°éƒ¨ç½²
-----------------
buildroot/docs/manual/getting.txt
buildroot/support/misc/Vagrantfile


vagrant up
```
192:vagrant_kiwi bamvor$ vagrant up
Bringing machine 'opensuse42.3' up with 'virtualbox' provider...
==> opensuse42.3: Importing base box 'opensuse/openSUSE-42.3-x86_64'...
==> opensuse42.3: Matching MAC address for NAT networking...
==> opensuse42.3: Checking if box 'opensuse/openSUSE-42.3-x86_64' is up to date...
==> opensuse42.3: Setting the name of the VM: vagrant_kiwi_opensuse423_1520604280467_51794
==> opensuse42.3: Clearing any previously set network interfaces...
==> opensuse42.3: Available bridged network interfaces:
1) en0: Wi-Fi (AirPort)
2) p2p0
3) awdl0
4) en2: é›·é›³ 1
5) en1: é›·é›³ 2
6) bridge0
==> opensuse42.3: When choosing an interface, it is usually the one that is
==> opensuse42.3: being used to connect to the internet.
    opensuse42.3: Which interface should the network bridge to? 0
    opensuse42.3: Which interface should the network bridge to? 1
==> opensuse42.3: Preparing network interfaces based on configuration...
    opensuse42.3: Adapter 1: nat
    opensuse42.3: Adapter 2: bridged
==> opensuse42.3: Forwarding ports...
    opensuse42.3: 22 (guest) => 2222 (host) (adapter 1)
==> opensuse42.3: Booting VM...
==> opensuse42.3: Waiting for machine to boot. This may take a few minutes...
    opensuse42.3: SSH address: 127.0.0.1:2222
    opensuse42.3: SSH username: vagrant
    opensuse42.3: SSH auth method: private key
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3:
    opensuse42.3: Vagrant insecure key detected. Vagrant will automatically replace
    opensuse42.3: this with a newly generated keypair for better security.
    opensuse42.3:
    opensuse42.3: Inserting generated public key within guest...
    opensuse42.3: Removing insecure key from the guest if it's present...
    opensuse42.3: Key inserted! Disconnecting and reconnecting using new SSH key...
==> opensuse42.3: Machine booted and ready!
==> opensuse42.3: Checking for guest additions in VM...
    opensuse42.3: The guest additions on this VM do not match the installed version of
    opensuse42.3: VirtualBox! In most cases this is fine, but in rare cases it can
    opensuse42.3: prevent things such as shared folders from working properly. If you see
    opensuse42.3: shared folder errors, please make sure the guest additions within the
    opensuse42.3: virtual machine match the version of VirtualBox you have installed on
    opensuse42.3: your host and reload your VM.
    opensuse42.3:
    opensuse42.3: Guest Additions Version: 5.1.30
    opensuse42.3: VirtualBox Version: 5.2
==> opensuse42.3: Setting hostname...
==> opensuse42.3: Configuring and enabling network interfaces...
==> opensuse42.3: Mounting shared folders...
    opensuse42.3: /vagrant => /Users/bamvor/works/source/bjzhang.github.io/public/sources/vagrant_kiwi
```
```
192:vagrant_kiwi bamvor$ vagrant ssh
Last failed login: Tue Nov 28 18:08:50 CET 2017 from 10.0.2.2 on ssh:notty
There were 7 failed login attempts since the last successful login.
Have a lot of fun...
vagrant@os74:~>
```
```
192:appliance_helper bamvor$ vagrant global-status --prune
id       name         provider   state   directory
------------------------------------------------------------------------------------------------------------------
b41836b  opensuse42.3 virtualbox running /Users/bamvor/works/source/bjzhang.github.io/public/sources/vagrant_kiwi

The above shows information about all known Vagrant environments
on this machine. This data is cached and may not be completely
up-to-date. To interact with any of the machines, you can go to
that directory and run Vagrant, or you can use the ID directly
with Vagrant commands from any directory. For example:
"vagrant destroy 1a2b3c4d"
192:appliance_helper bamvor$ vagrant ssh b41836b
Last login: Fri Mar  9 15:06:34 2018 from 10.0.2.2
Have a lot of fun...
vagrant@os74:~>
```


