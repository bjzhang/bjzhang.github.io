---
layout: post
title:  Terraform and Vagrant（Linux自动化部署工具之四）
categories: [Software]
tags: [Linux, appliance]
---

wget Vagrantfile
mkdir vagrant_kiwi
cd vagrant_kiwi
vagrant up

vagrant push
<https://www.hashicorp.com/blog/vagrant-push-one-command-to-deploy-any-application>

自动安装需要干预安装过程，每个发行版有自己的安装程序，上面列出的autoyast和kiwistart都只支持特定的发行版。自动安装通常的场景是有几台机器需要选择相同的安装选项，软件包，配置文件，或安装后简单的自定义设置。管理员先手工安装第一台机器，安装后目标机器会带有autoyast或kickstart的配置文件（默认在root目录下: suse/opensuse "/root/\*.xml", redhat: "/root/anaconda-ks.cfg"），管理员调整这个配置文件后，使用这个配置文件安装其余几台机器。

多说一句其实os x现在可以支持kvm了<https://github.com/kholia/OSX-KVM>，所以道理上讲kvm的镜像也可以用在os x上，如果是这样的话，virt-builder构建出的镜像也可以用于os x。但os x kvm毕竟不是默认可用的，暂时不考虑。

vagrant跨平台部署
-----------------
buildroot/docs/manual/getting.txt
buildroot/support/misc/Vagrantfile


vagrant up
```
192:vagrant_kiwi bamvor$ vagrant up
Bringing machine 'opensuse42.3' up with 'virtualbox' provider...
==> opensuse42.3: Importing base box 'opensuse/openSUSE-42.3-x86_64'...
==> opensuse42.3: Matching MAC address for NAT networking...
==> opensuse42.3: Checking if box 'opensuse/openSUSE-42.3-x86_64' is up to date...
==> opensuse42.3: Setting the name of the VM: vagrant_kiwi_opensuse423_1520604280467_51794
==> opensuse42.3: Clearing any previously set network interfaces...
==> opensuse42.3: Available bridged network interfaces:
1) en0: Wi-Fi (AirPort)
2) p2p0
3) awdl0
4) en2: 雷雳 1
5) en1: 雷雳 2
6) bridge0
==> opensuse42.3: When choosing an interface, it is usually the one that is
==> opensuse42.3: being used to connect to the internet.
    opensuse42.3: Which interface should the network bridge to? 0
    opensuse42.3: Which interface should the network bridge to? 1
==> opensuse42.3: Preparing network interfaces based on configuration...
    opensuse42.3: Adapter 1: nat
    opensuse42.3: Adapter 2: bridged
==> opensuse42.3: Forwarding ports...
    opensuse42.3: 22 (guest) => 2222 (host) (adapter 1)
==> opensuse42.3: Booting VM...
==> opensuse42.3: Waiting for machine to boot. This may take a few minutes...
    opensuse42.3: SSH address: 127.0.0.1:2222
    opensuse42.3: SSH username: vagrant
    opensuse42.3: SSH auth method: private key
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3: Warning: Remote connection disconnect. Retrying...
    opensuse42.3: Warning: Connection reset. Retrying...
    opensuse42.3:
    opensuse42.3: Vagrant insecure key detected. Vagrant will automatically replace
    opensuse42.3: this with a newly generated keypair for better security.
    opensuse42.3:
    opensuse42.3: Inserting generated public key within guest...
    opensuse42.3: Removing insecure key from the guest if it's present...
    opensuse42.3: Key inserted! Disconnecting and reconnecting using new SSH key...
==> opensuse42.3: Machine booted and ready!
==> opensuse42.3: Checking for guest additions in VM...
    opensuse42.3: The guest additions on this VM do not match the installed version of
    opensuse42.3: VirtualBox! In most cases this is fine, but in rare cases it can
    opensuse42.3: prevent things such as shared folders from working properly. If you see
    opensuse42.3: shared folder errors, please make sure the guest additions within the
    opensuse42.3: virtual machine match the version of VirtualBox you have installed on
    opensuse42.3: your host and reload your VM.
    opensuse42.3:
    opensuse42.3: Guest Additions Version: 5.1.30
    opensuse42.3: VirtualBox Version: 5.2
==> opensuse42.3: Setting hostname...
==> opensuse42.3: Configuring and enabling network interfaces...
==> opensuse42.3: Mounting shared folders...
    opensuse42.3: /vagrant => /Users/bamvor/works/source/bjzhang.github.io/public/sources/vagrant_kiwi
```
```
192:vagrant_kiwi bamvor$ vagrant ssh
Last failed login: Tue Nov 28 18:08:50 CET 2017 from 10.0.2.2 on ssh:notty
There were 7 failed login attempts since the last successful login.
Have a lot of fun...
vagrant@os74:~>
```
```
192:appliance_helper bamvor$ vagrant global-status --prune
id       name         provider   state   directory
------------------------------------------------------------------------------------------------------------------
b41836b  opensuse42.3 virtualbox running /Users/bamvor/works/source/bjzhang.github.io/public/sources/vagrant_kiwi

The above shows information about all known Vagrant environments
on this machine. This data is cached and may not be completely
up-to-date. To interact with any of the machines, you can go to
that directory and run Vagrant, or you can use the ID directly
with Vagrant commands from any directory. For example:
"vagrant destroy 1a2b3c4d"
192:appliance_helper bamvor$ vagrant ssh b41836b
Last login: Fri Mar  9 15:06:34 2018 from 10.0.2.2
Have a lot of fun...
vagrant@os74:~>
```

